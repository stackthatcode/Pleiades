@using Pleiades.Web.MvcHelpers

@section _Scripts {   
	@Html.Partial("_ImageBundleViewer")
    
    <!-- Endless Glider -->
    <script type="text/javascript">
        var EndlessGlider = function (container, divId1, divId2) {
            var self = this;

            self.WorkspaceTemplate = ko.observable(null);
            self.EditorTemplate1 = ko.observable(null);
            self.EditorTemplate2 = ko.observable(null);
            self.ActiveEditor = null;

            self.Init = function (workspaceTemplate, editorTemplate) {
                self.ActiveEditor = 1;
                self.WorkspaceTemplate(workspaceTemplate);
                self.EditorTemplate1(editorTemplate);
                $(divId2).hide();
            }

            self.GlideToRight = function (workspaceTemplate, editorTemplate) {
                self.Glide(workspaceTemplate, editorTemplate, "RIGHT");
            }

            self.GlideToLeft = function (workspaceTemplate, editorTemplate) {
                self.Glide(workspaceTemplate, editorTemplate, "LEFT");
            }

            self.Glide = function (workspaceTemplate, editorTemplate, direction, callback) {
                var prevDiv, nextDiv, nextEditorTemplate;
                if (self.ActiveEditor == 1) {
                    prevDiv = divId1;
                    nextDiv = divId2;
                    nextEditorTemplate = self.EditorTemplate2;
                } else {
                    prevDiv = divId2;
                    nextDiv = divId1;
                    nextEditorTemplate = self.EditorTemplate1;
                }

                var glideLeftFunction = function (callback) {
                    $(nextDiv).css({ display: "block", left: "-940px", top: "0px"  });
		
	                $(prevDiv).animate({ 
                            left: "+=940" 
		                }, 
		                { 	
			                complete: function() { $(prevDiv).css({ display: "none" }); },
			                duration: 250, 
		                }
	                );
	                $(nextDiv).animate({ 	
			                left: "+=940" 
		                }, 
		                { 	
			                complete:callback,
			                duration: 250,
		                }
	                );
                }
                
                var glideRightFunction = function (callback) {
                    $(nextDiv).css({ display: "block", left: "+940px", top: "0px"  });
		
	                $(prevDiv).animate({ 
                            left: "-=940" 
		                }, 
		                { 	
			                complete: function() { $(prevDiv).css({ display: "none" }); },
			                duration: 250, 
		                }
	                );
	                $(nextDiv).animate({ 	
			                left: "-=940" 
		                }, 
		                {
			                complete: callback,
			                duration: 250,
		                }
	                );
                }

                flow.exec(
                    function () {
                        nextEditorTemplate(editorTemplate);
                        if (direction == "LEFT") {
                            glideLeftFunction(this);
                        } else {
                            glideRightFunction(this);
                        }
                    },
                    function () {
                        self.ActiveEditor = self.ActiveEditor == 1 ? 2 : 1;

                        self.WorkspaceTemplate(workspaceTemplate);
                    }
                );
            }
        }
    </script>

    <!-- List Model Functions -->
    <script type="text/javascript">
        var AddListFunctions = function (model) {
            var self = model;
            self.BrandArray = ko.observableArray();
            self.CategoryArray = ko.observableArray();

            self.RetrieveCategoriesList = function (callback) {
                flow.exec(
                    function () {
                        self.Service.AjaxGet("/Admin/Product/Categories", this);
                    },
                    function (data) {
                        self.CategoryArray.removeAll();
                        self.CategoryArray.push({ value: null, text: "(Select a Category)" });

                        var addCategory = function (category, indent) {
                            self.CategoryArray.push({ value: category.Id, text: indent + category.Name });
                            $.each(category.Categories, function (index, elem) { addCategory(elem, indent + '....'); });
                        }
                        $.each(data, function (index, elem) { addCategory(elem, ''); });
                        if (callback) {
                            callback();
                        }
                    }
                );
            }

            self.RetrieveBrandsList = function (callback) {
                flow.exec(
                    function () {
                        self.Service.AjaxGet("/Admin/Product/Brands", this);
                    },
                    function (data) {
                        self.BrandArray.removeAll();
                        self.BrandArray.push({ value: null, text: "(Select a Brand)" });

                        $.each(data, function (index, elem) {
                            self.BrandArray.push({ value: elem.Id, text: elem.Name });
                        });

                        if (callback) {
                            callback();
                        }
                    }
                );
            }
        }
    </script>

    <!-- Search Functions -->
	<script type="text/javascript">
	    var AddSearchFunctions = function (model) {
	        self = model;

	        self.SearchData = ko.observableArray();
	        self.QuantityArray = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
	        self.CartItems = ko.observableArray();

	        self.NumberOfCartItems = ko.computed(function () {
	            var quantity = 0;
	            $.each(self.CartItems(), function (index, elem) {
	                quantity = quantity + elem.Quantity();
	            });
	            return quantity;
	        });

	        self.ViewCart = function () {
	            if (self.CartItems().length == 0) {
	                self.ShowModal("Notification", {
	                    Header: "The Shopping Cart is Empty",
	                    Body: "Add Items to the Order"
	                });
	            } else {
	                $("btn-view-cart").hide();
	                self.GlideRight("ReviewProducts");
	            }
	        }

	        self.SearchClick = function (callback) {
	            flow.exec(
                    function () {
                        var brandId = $("#SearchBrand").val();
                        var categoryId = $("#SearchCategory").val();
                        var searchText = $("#SearchText").val();
                        self.Service.AjaxGet("/Admin/Product/Search" +
                            "?brandId=" + brandId + "&categoryId=" + categoryId + "&searchText=" + searchText, this);
                    },
                    function (data) {
                        $.each(data, function (index, elem) {
                            elem.ExpandInventory = ko.observable(false);
                            elem.Inventory = ko.observableArray([]);
                        });
                        self.SearchData(data);
                        if (callback) {
                            callback();
                        }
                    }
                );
	        }

	        self.AddToCart = function (item, product) {
	            if (!item.SelectedQuantity()) {
	                return;
	            }
	            if (self.CartItems().length == 20) {
	                self.ShowModal("Notification", {
	                    Header: "The Shopping Cart is Full",
	                    Body: "You can only add 20 distinct Skus per Order"
	                });
	            }

	            var itemInCart = self.CartItems().firstOrNull(function (x) { return x.Item.SkuCode == item.Item.SkuCode; });
	            if (itemInCart) {
	                if (itemInCart.Quantity() + item.SelectedQuantity() > 99) {
	                    self.ShowModal("Notification", {
	                        Header: "Maximum Number of Items",
	                        Body: "You can only add 99 of the same Item"
	                    });
	                    return;
	                }
	                itemInCart.Quantity(itemInCart.Quantity() + item.SelectedQuantity());
	            } else {
	                if (self.CartItems.length == 100) {
	                    self.ShowModal("Notification", {
	                        Header: "Maximum Number of Distinct Items",
	                        Body: "You can only add 99 of the same Sku per Order"
	                    });
	                    return;
	                }

	                self.CartItems.push({ Quantity: ko.observable(item.SelectedQuantity()), Item: item.Item, Product: product });
	            }
	            $("#AddFeedback").show();
	            $("#AddFeedback").fadeOut({ duration: 1000 });
	            item.SelectedQuantity(null);
	        }

	        self.ShowInventory = function (data) {
	            flow.exec(
                    function () {
                        self.Service.AjaxGet("/Admin/Product/Inventory/" + data.Id, this);
                    },
                    function (inventory) {
                        data.ExpandInventory(true);
                        $.each(inventory, function (index, elem) {
                            data.Inventory.push({ SelectedQuantity: ko.observable(0), Item: elem });
                        });
                    }
                );
	        }

	        self.HideInventory = function (data) {
	            data.ExpandInventory(false);
	        }

	    }
    </script>
    
    <!-- Review Products Functions -->
	<script type="text/javascript">
	    var AddReviewProductsFunctions = function (model) {
	        var self = model;

	        self.SelectedCartItem = ko.observable(null);

	        self.BackToProductSearch = function () {
	            $("[name='glideToSearch']").hide();
	            self.GlideLeft("SelectProducts");
	        }

	        self.CartItemClick = function (data) {
	            flow.exec(
                    function () {
                        self.Service.AjaxGet("/Admin/Product/Colors/" + data.Product.Id, this);
                    },
                    function (colors) {
                        console.log(colors);
                        self.Service.AjaxGet("/Admin/Product/Sizes/" + data.Product.Id, this);
                    },
                    function (sizes) {
                        console.log(sizes);
                        self.Service.AjaxGet("/Admin/Product/Inventory/" + data.Product.Id + "?regenerate=false", this);
                    },
                    function (inventory) {
                        console.log(inventory);

                        data.EditQuantity = ko.observable(data.Quantity());
                        self.SelectedCartItem(data);
                        //console.log(data.Item);
                        //console.log(data.Product);
                    }
                );
	        }

	        self.CartItemCancel = function () {
	            self.SelectedCartItem(null);
	        }

	        self.CartItemDelete = function (data) {
	            self.CartItems.remove(data);
	        }

	        self.CartItemOk = function () {
	            self.SelectedCartItem(null);
	        }

	        self.PerpetualGlideTest = function () {
	            $("[name='glideToSearch']").hide();
	            self.GlideRight("SelectProducts");
	        }
	    }
    </script>

    <!-- View Model Functions -->
	<script type="text/javascript">
	    var CreateOrderViewModel = function () {
	        var self = this;

	        // Service + Cross-cutting Stuff
	        var commonUI = new CommonUI();
	        self.Service = new AjaxService(commonUI.Error, commonUI.ShowLoading, commonUI.HideLoading);

	        // Modal state + functions
	        self.ModalViewModel = ko.observable({ Template: null, Data: null });

	        self.ShowModal = function (template, data) {
	            self.ModalViewModel({ Template: "Modal-Dialog-" + template, Data: data });
	            $('#modal-dialog').modal('show');
	        };

	        self.HideModal = function () {
	            $('#modal-dialog').modal('hide');
	        }

	        // Glider functions
	        var glider = new EndlessGlider("#gliding-container", "#glider1", "#glider2");
	        glider.Init("Top-Workspace-SelectProducts", "Main-Editor-SelectProducts");
	        self.EndlessGlider = glider;

	        self.GlideLeft = function (template) {
	            self.EndlessGlider.GlideToLeft("Top-Workspace-" + template, "Main-Editor-" + template);
	        }

	        self.GlideRight = function (template) {
	            self.EndlessGlider.GlideToRight("Top-Workspace-" + template, "Main-Editor-" + template);
	        }
	    }
    </script>

    <!-- document.ready() Functions -->
	<script type="text/javascript">
	    $(function () {
	        var model = new CreateOrderViewModel();
	        AddListFunctions(model);
	        AddSearchFunctions(model);
	        AddReviewProductsFunctions(model);
	        ko.applyBindings(model);

	        flow.exec(
                function () {
                    model.RetrieveCategoriesList(this);
                },
                function () {
                    model.RetrieveBrandsList(this);
                }
            );

	        window.Automation = function () {
	            flow.exec(
                    function () {
                        model.SearchClick(this);
                    },
                    function () {
                        model.ShowInventory(model.SearchData()[1]);
                        window.setTimeout(this, 1000);
                    },
                    function () {
                        var addToCart = $("a[name='add-to-cart']")[6];
                        var product = model.SearchData()[1];
                        var inventory = product.Inventory();
                        var item = inventory[6];
                        item.SelectedQuantity(3);
                        model.AddToCart(item, product);
                        this();
                    },
                    function () {
                        model.ShowInventory(model.SearchData()[0]);
                        window.setTimeout(this, 1000);
                    },
                    function () {
                        var addToCart = $("a[name='add-to-cart']")[6];
                        var product = model.SearchData()[0];
                        var inventory = product.Inventory();
                        var item = inventory[1];
                        item.SelectedQuantity(2);
                        model.AddToCart(item, product);
                    }
                );
	        }
	    });
	</script>
}

@section _Templates {
    <style>
        table.skutable tbody tr td:nth-child(1)
        {
            width:200px;
        }
        table.skutable tbody tr td:nth-child(2)
        {
            width:150px;
            text-align: right;
        }
        table.skutable tbody tr td:nth-child(3)
        {
            width:150px;
            text-align: right;
        }
        table.skutable tbody tr td:nth-child(4)
        {
            width:150px;
            text-align: right;
        }
        table.skutable tbody tr td:nth-child(5)
        {
            width:150px;
            text-align: right;
        }        
        table.editcart tr td
        {
            border-top: none; 
        }
    </style>
	<!-- KNOCKOUT TEMPLATES - Select Products -->
	<script type="text/html" id="Top-Workspace-SelectProducts">
        <div class="workspace-heading" style="height:125px;">
		    <div id="heading" class="container">
                <div class="row">
				    <div class="span7">
					    <h1>Create Order &gt; Add Items</h1>
				    </div>
                    <div class="span2" style="margin-top:20px; text-align:right;">
                        <div id="AddFeedback" style="display:none;">
                            <span class="label label-info"> <i class="icon-star icon-white"></i>Item Added! &nbsp;</span>
                        </div>
                    </div>
				    <div class="span3" style="margin-top:15px; text-align:right;">
					    <a id="btn-view-cart" class="btn btn-primary" style="width:190px;" data-bind="click: $root.ViewCart">
                            <i class="icon-shopping-cart icon-white"></i> View Cart (<span data-bind="text: $root.NumberOfCartItems"></span> Items) &nbsp;
                            <i class="icon-arrow-right icon-white"></i></a>
				    </div>
			    </div>

                <div style="height:20px;"></div>
                
                <div class="row">
				    <div class="span3">
                        <select id="SearchCategory" data-bind="foreach: $data.CategoryArray">
                            <option data-bind="value: $data.value, text: $data.text"  />
                        </select>
                    </div>
				    <div class="span3">
                        <select id="SearchBrand" data-bind="foreach: $data.BrandArray">
                            <option data-bind="value: $data.value, text: $data.text"  />
                        </select>
                    </div>
                    <div class="span3">
                        <input id="SearchText" type="text" class="input-large" placeholder="Description, Name, Sku..." />
                    </div>
				    <div class="span3">
					    <a class="btn btn-inverse btn-block" data-bind="click: function() { $data.SearchClick(); }">Search <i class="icon-search icon-white"></i></a>
                    </div>
                </div>
		    </div>
        </div>
	</script>
	<script type="text/html" id="Main-Editor-SelectProducts">
        <div style="margin-top:20px; margin-bottom:200px;">
            <div style="margin-top:50px; text-align:center;" class="alert alert-info" data-bind="visible: $root.SearchData().length == 0">
			    <strong>There are no Products in your current search.  Click "Search" to run a search or click "Add New Product" to create a new one.</strong>  
		    </div>
		    
		    <table id="parent-editor-table" class="table" data-bind="visible: $root.SearchData().length > 0">
		    <tbody data-bind="foreach: $root.SearchData()">
			    <tr>
			    <td style="vertical-align:top;">
				    <div style="width:100px">
                	    <div data-bind="template: { name: 'Image-Bundle-Thumbnail-Viewer', data: { ExternalResourceId: $data.ImageBundleExternalId, LightboxSuffixId: 'Parent' } }">
			            </div>
                    </div>
                </td>

                <td style="vertical-align:top; padding-top:20px;">
                    <div style="width:808px;">
                        <div style="width:604px;float:left;">
					        <p>
                                <h4 data-bind="text: $data.Name" style="margin-bottom:5px;"></h4>
                                <span style="margin-right:10px;" data-bind="text: 'Brand: ' + $data.BrandName"></span>
                                <span style="margin-right:10px;" data-bind="text: 'Cost: ' + ToMoney($data.UnitPrice)"></span>
                                <span data-bind="text: 'Price: ' + ToMoney($data.UnitPrice)"></span>
                            </p>
                        </div>

                        <div style="width:204px;float:left; text-align:right;">
					        <div data-bind="ifnot: $data.ExpandInventory">
                                <a name="btn-expand-inventory" class="btn btn-white" href="#" data-bind="click: function() { $root.ShowInventory($data) }">
                                <i class="icon-chevron-up icon-black"></i> Show Inventory</a>
                            </div>

					        <div data-bind="if: $data.ExpandInventory">
                                <a class="btn btn-white" href="#" data-bind="click: function() { $root.HideInventory($data) }">
                                <i class="icon-chevron-down icon-black"></i> Hide Inventory</a>
                            </div>
                        </div>
                    </div>

                    <div name="expanded-inventory" data-bind="if: $data.ExpandInventory">
                        <table class="skutable table-striped table-hover table-condensed">
                        <thead>
                            <th>Sku Code</th>
                            <th style="text-align:right;">Reserved</th>
                            <th style="text-align:right;">In Stock</th>
                            <th style="text-align:right;">Quantity</th>
                            <th style="text-align:right;">Add to Cart</th>
                        </thead>
                        <tbody data-bind="foreach: $data.Inventory">
                        <tr>
                            <td><span data-bind="text: $data.Item.SkuCode"></span></td>
                            <td><span data-bind="text: $data.Item.ReservedInventory"></span></td>
                            <td><span data-bind="text: $data.Item.TotalInventory"></span></td>
                            <td><select name="quantity-select" style="width:125px; margin-bottom:0px;" data-bind='options: $root.QuantityArray, optionsCaption: "How many...", value: $data.SelectedQuantity'></select></td>
                            <td><a name="add-to-cart" href="#" data-bind="click: function() { $root.AddToCart($data, $parent); }" style="color:#333;"><i class="icon-shopping-cart icon-blue"></i> Add to Cart</a></td>
                        </tr>
                        </tbody>
                        </table>
                    </div>
			    </td>
			    </tr>
		    </tbody>
		    </table>
        </div>
	</script>
	
	<!-- KNOCKOUT TEMPLATES - Review Products -->
	<script type="text/html" id="Top-Workspace-ReviewProducts">
		<div id="heading" class="container">
            <div class="row">
				<div class="span9">
					<h1>Create Order &gt; Review Cart</h1>
				</div>
				<div class="span3" style="margin-top:15px; text-align:right;">
                    <a id="btn-view-cart" class="btn btn-primary" style="width:190px;" data-bind="click: $root.PerpetualGlideTest">
                        Add Shipping Address <i class="icon-arrow-right icon-white"></i>
                    </a>
				</div>
			</div>

            <div class="row">
                <div class="span7" style="height:48px;">
                    <ul class="nav nav-pills">
                        <li style="width:200px;">
				            <a name="glideToSearch" href="#" class="backbutton" data-bind="click: $root.BackToProductSearch">&laquo; Add More Items To Cart</a>
                            &nbsp;
                        </li>
                    </ul
                </div>
            </div>
		</div>
	</script>
	<script type="text/html" id="Main-Editor-ReviewProducts">
        <div style="margin-bottom:200px;">
		    <table class="table table-hover">
			    <tbody data-bind="foreach: $root.CartItems">
                    <tr data-bind="ifnot: $root.SelectedCartItem() == $data, click: $root.CartItemClick">
                        <td style="width:100px">
                	        <div data-bind="template: { name: 'Image-Bundle-Thumbnail-Viewer', data: { ExternalResourceId: $data.Product.ImageBundleExternalId, LightboxSuffixId: 'Review' } }">
			                </div>
                        </td>
                        <td style="width:800px;">
                            <div style="width:250px; vertical-align:top; float:left;">
                                <strong data-bind="text: $data.Product.Name"></strong><br/>
                                <span>Sku Code: </span> <span data-bind="text: $data.Item.SkuCode"></span><br/>
                                <span data-bind="if: $data.Item.Color">Color: <span data-bind="text: $data.Item.Color.Name"></span></span><br/>
                                <span data-bind="if: $data.Item.Size">Size: <span data-bind="text: $data.Item.Size.Name"></span></span><br/>
                            </div>
                            <div style="width:150px; vertical-align:top; float:left; text-align:left;">
                                <br />
                                <span>Unit Price:</span> <span data-bind="text: ToMoney($data.Product.UnitPrice)"></span>
                            </div>
                            <div style="width:100px; vertical-align:top; float:left; text-align:right;">
                                <br />
                                <span>Quantity:</span> <span data-bind="text: $data.Quantity"></span>
                            </div>
                            <div style="width:300px; text-align:right; float:left; padding-top:30px;">
                                <a class="btn btn-primary" style="width:75px;" href="#" data-bind="click: $root.CartItemClick"><i class="icon-pencil icon-white"></i> Edit</a>
                            </div>
                        </td>
                    </tr>

                    <tr data-bind="if: $root.SelectedCartItem() == $data">
                        <td style="width:100px; vertical-align:top;">
                	        <div data-bind="template: { name: 'Image-Bundle-Thumbnail-Viewer', data: { ExternalResourceId: $data.Product.ImageBundleExternalId, LightboxSuffixId: 'Review' } }">
			                </div>
                        </td>
                        <td style="width:800px;">
                              <div style="width:250px; vertical-align:top; float:left;">
                                <strong data-bind="text: $data.Product.Name"></strong><br/>
                                <span>Sku Code: </span> <span data-bind="text: $data.Item.SkuCode"></span><br/>
                                <span data-bind="if: $data.Item.Color">Color: <span data-bind="text: $data.Item.Color.Name"></span></span><br/>
                                <span data-bind="if: $data.Item.Size">Size: <span data-bind="text: $data.Item.Size.Name"></span></span><br/>
                                
                            </div>
                            <div style="width:150px; vertical-align:top; float:left; text-align:left;">
                                <br />
                                <span>Unit Price:</span> <span data-bind="text: ToMoney($data.Product.UnitPrice)"></span>
                            </div>
                            <div style="width:100px; vertical-align:top; float:left; padding-top:15px; text-align:right;">
                                <select name="quantity-select" style="width:90px; margin-bottom:0px;" data-bind='options: $root.QuantityArray, optionsCaption: "How many...", value: $data.EditQuantity'></select>                             
                            </div>
                            <div style="width:300px; text-align:right; float:left; padding-top:30px;">
                                <a class="btn btn-primary" href="#" data-bind="click: $root.CartItemOk"><i class="icon-ok icon-white"></i> Ok</a>
					            <a class="btn btn-primary" href="#" data-bind="click: $root.CartItemDelete"><i class="icon-trash icon-white"></i> Delete</a>
					            <a class="btn btn-inverse" href="#" data-bind="click: $root.CartItemCancel"><i class="icon-remove icon-white"></i> Cancel</a>
                            </div>
                            </table>
                        </td>
                    </tr>
			    </tbody>
		    </table>
        </div>
	</script>

    <!-- KNOCKOUT TEMPLATE - Shopping Cart Editor Rows -->

    <!-- Load the Product & Images -->

    <!-- Product Options - if Colors choose these -->
    <!-- Product Options - if Sizes choose these -->

    <!-- Product Skus - computed - if (SelectedColor), if (SelectedSize) ... filter SkuList -->

    <script type="text/html" id="Main-Editor-CartItem-NoSizeNoColor">
    </script>
    <script type="text/html" id="Main-Editor-CartItem-NoSizes">
    </script>
    <script type="text/html" id="Main-Editor-CartItem-NoColor">
    </script>


	<!-- KNOCKOUT TEMPLATE - Modal Dialogs -->
	<script type="text/html" id="Modal-Dialog-Notification">
		<div id="modal-dialog" class="modal hide fade">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h3><span data-bind="text: $data.Header"></span></h3>
			</div>
			<div class="modal-body">
				<p><span data-bind="text: $data.Body"></span></p>
			</div>
			<div class="modal-footer">
				<a href="#" id="modal-action" class="btn btn-primary" data-bind="click: $root.HideModal"><i class="icon-ok icon-white"></i> Ok</a>
			</div>
		</div>		
	</script>
}

@section _Body {
    <div class="workspace-heading-parent">
		<div class="workspace-heading" data-bind="template: { name: $root.EndlessGlider.WorkspaceTemplate() }">
        </div>
	</div>
	<div id="gliding-container" class="container">
		<div id="glider1" class="glider" data-bind="template: { name: $root.EndlessGlider.EditorTemplate1() }"></div>		
		<div id="glider2" class="glider" data-bind="template: { name: $root.EndlessGlider.EditorTemplate2() }"></div>
    </div>
    <div id="modal-enclave" 
        data-bind="template: { name: $root.ModalViewModel().Template, data: $root.ModalViewModel().Data }">
    </div>    
}
