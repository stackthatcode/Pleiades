<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>pushmarket - edit categories</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script type="text/javascript" src="jquery-1.8.2.min.js"></script>
	<script type="text/javascript" src="knockout-2.1.0.js"></script>	
    <link href="./bootstrap/css/bootstrap.css" rel="stylesheet">
	
	<!-- Templates -->
    <style type="text/css">
		body {
			padding-top: 60px;
			padding-bottom: 40px;
		}
		
		.table td {
			vertical-align:middle;
		}
		
		h4 {
			color: #666;
		}
		
		.editorRow:hover {
			background-color: #c4e3f3;
		}
		
		.workspace-heading { 
			position:fixed; 
			margin-top:60px; 
			top:0px; 
			width:100%; 
			height:75px; 
			background-color:#FFF; 
			border-bottom:1px dotted #CCC;
		}
    </style>	
	
	<!-- TODO: move these to a Partial View :-D -->
	<script type="text/html" id="parent-editor-heading">
		<div id="heading" class="container" data-bind="ifnot: $root.ChildViewMasterRecord">
			<div class="row">
				<div class="span9">
					<h1>All Categories</h1>
				</div>
				<div class="span3" style="margin-top:15px; text-align:right;">
					<a class="btn btn-primary btn-block" data-bind="click: $root.AddChildViewMasterRecord">Add New Category <i class="icon-arrow-right icon-white"></i></a>
				</div>
			</div>
		</div>		
		<div id="heading" class="container" data-bind="if: $root.ChildViewMasterRecord">
			<div class="row" style="position:relative;">
				<!-- TODO: centralize this style -->
				<div style="left:-75px; margin-top:15px; position:absolute; text-align:right;">
					<a class="btn btn-inverse" data-bind="click: $root.BackToParentView"><i class="icon-arrow-left icon-white"></i> Back</a>
				</div>
				<div class="span9">
					<h1><span data-bind="text: $root.ChildViewMasterRecord().Name"></span></h1>
				</div>
				<div class="span3" style="margin-top:15px; text-align:right;">
					<a class="btn btn-primary btn-block" data-bind="click: $root.AddChildViewRecord"><i class="icon-plus icon-white"></i> Add Sub-Category</a>
				</div>
			</div>
		</div>
	</script>
	
	<script type="text/html" id="parent-editor-workspace">
		<table class="table table-hover">
			<tbody data-bind="foreach: $root.Categories">
			<tr>
				<td>
					<span class="span9">
						<h4 data-bind="text: Name"></h4>
						<div data-bind="foreach: $data.Categories">
							<h4 style="padding-left:40px;">&raquo; <span data-bind="text: Name"></span></h4>
						</div>
					</span>
					<span class="span3" style="text-align:right;">
						<a class="btn" href="#"><i class="icon-chevron-up"></i></a>
						<a class="btn btn-inverse" data-bind="click: $root.GotoChildView">Edit Category<i class="icon-arrow-right icon-white"></i></a>
					</span>
				</td>
			</tr>
			</tbody>
		</table>
	</script>
	
	<script type="text/html" id="child-editor-workspace">
		<!-- Child Categories -->
		<table class="table table-hover">
			<tbody data-bind="foreach: $root.ChildViewMasterRecord().Categories">
			<tr data-bind="if: $root.ChildViewRecordEditing() != $data, click: $root.EditChildViewRecord">
				<td>
					<span class="span9">
						<h4 data-bind="if: $data.ParentId == null, text: $data.Name()"></h4>
						<h4 data-bind="if: $data.ParentId != null, text: '&raquo; ' + $data.Name()"></h4>						
						<span data-bind="text: $data.SEO()"></span>
					</span>
					<span class="span3" style="text-align:right;">
						<p>Touch Row to Edit</p>
					</span>
				</td>
			</tr>			
			<tr data-bind="if: $root.ChildViewRecordEditing() == $data">
				<td style="background-color:#EEE;">
					<form>
					<div>
						<span class="span8" style="float:left;padding-top:5px;"><!-- TODO: why is this float:left?  thought that was automatic...? -->
							<input id="entry" style="float:left; width:250px; margin-right:20px;" class="input-large" type="text" placeholder="Enter Category Name" data-bind="value: $data.EditName" />
							
							<input id="entry" style="float:left; width:250px;" class="input-large" type="text" value="sport-casual-seo-tag" placeholder="Enter SEO Tag" data-bind="value: $data.EditSEO" />
						</span>
						<span class="span4" style="padding-top:5px; text-align:right;">
							<a class="btn btn-primary" href="#" data-bind="click: $root.SaveRecord"><i class="icon-ok icon-white"></i> Save</a>
							<a class="btn btn-inverse" href="#" data-bind="click: $root.CancelEdit"><i class="icon-remove icon-white"></i> Cancel</a>
							<a class="btn btn-inverse" href="#"><i class="icon-search icon-white"></i> Products</a>
						</span>
					</div>					
					<div style="clear:both; height:20px;width:1px;"></div>
					</div>					
					<div>
						<span class="span9" style="float:left;">					
							<a class="btn btn-primary" href="#"><i class="icon-trash icon-white"></i> Delete</a>							
							<!-- TODO: wire this into the matrix -->
							<a class="btn btn-primary dropdown-toggle" data-toggle="dropdown" href="#">
								Change Parent Category...
								<span class="caret"></span>
							</a>							
							<ul class="dropdown-menu">
							</ul>
						</span>						
						<span class="span3">
						</span>
					</div>
					</form>
				</td>
			</tr>
			</tbody>
		</table>
	</script>
	
	<!-- TODO: don't forget scroll spy, brah! -->	
	<script type="text/javascript">						
		function CategoryViewModel(dataAdapter) {	
			var self = this;
			
			// transformers
			self.AllCategoriesToViewModel = function(data) {
				var output = ko.observableArray();
				$.each(data, function(index, category) { output.push(self.CategoryToViewModel(category)); });
				return output;
			}
			
			self.CategoryToViewModel = function(masterCategory) {
				var viewModel = ko.observableArray();
				
				$.each(masterCategory.Categories, function (index, element) {
					viewModel.push({
						Id: element.Id,
						ParentId: element.ParentId,
						Name: ko.observable(element.Name),
						SEO: ko.observable(element.SEO),
					});
				});			
				return viewModel;
			}
			
			self.CategoryToServerModel = function(category) {
				var model = {
					Id: category.Id,
					Name: category.Name(),
					SEO: category.SEO(),
					ParentId: category.ParentId
				};
				return model;
			};
			
			// state management methods
			self.GotoSingleParentView = function(masterRecord) {
				if (self.ParentViewEnabled === false) { return; }
				self.ParentViewEnabled = false;
				
				if (masterRecord.Id != null) {
					masterRecord = self.CategoryToViewModel(self.DataAdapter.RetrieveParentCategory(masterRecord.Id));
				}
				
				// TODO: error handling for confirm existence, if not, throwup a message, reenable ParentView
				
				self.ChildViewMasterRecord(masterRecord);
				self.Glider.GlideToChild();				
				self.ChildViewEnabled = true;
			}
			
			self.BackToAllParentsView = function() { 
				if (self.ChildViewEnabled === false) { return; }
				self.ChildViewEnabled = false;
				
				self.Categories(self.AllMasterCategoriesToViewModel(self.DataAdapter.RetrieveAllCategories()));
				
				self.Glider.GlideToParent();
				self.ChildViewMasterRecord(null);
				self.ChildViewRecordEditing(null);				
				self.ParentViewEnabled = true;
			}
			
			self.EditRecord = function(record) {
				if (self.ChildViewEnabled === false) { return; }
				
				record.EditName = ko.observable(record.Name());
				record.EditSEO = ko.observable(record.SEO());
				
				self.ChildViewRecordEditing(record);
			}
			
			self.SaveRecord = function(record) {
				if (self.ChildViewEnabled === false) { return; }
				
				record.Name(record.EditName());
				record.SEO(record.EditSEO());
				
				// TODO: get the Id from the server...!
				self.DataAdapter.SaveCategory(self.CategoryToServerModel(record));
				
				///self.CategoryToServerModel(self.ChildViewMasterRecord()));				
				//var data = self.DataAdapter.RetrieveParentCategory(self.ChildViewMasterRecord().Id);
				
				//self.ChildViewMasterRecord(self.CategoryToViewModel(data));
				self.ChildViewRecordEditing(null);
			}
			
			self.CancelEdit = function(record) {
				if (self.ChildViewEnabled === false) { return; }
				
				self.ChildViewRecordEditing(null);
			}
						
			self.AddParentRecord = function() {
				if (self.ParentViewEnabled === false) { return; }

				var newCategory = {
					Id: null,	// TODO: remove this Id
					Name: ko.observable("New Category"),
					SEO: ko.observable("new-category"),
					ChildCategories: ko.observableArray(),
				};
				self.Categories.unshift(newCategory);
				self.GotoChildView(newCategory);
			}
			
			self.AddChildRecord = function() {
				if (self.ChildViewEnabled === false) { return; }
				
				var newCategory = {
					Id: null,
					Name: ko.observable("New Category"),
					SEO: ko.observable("new-category")
				};
				
				self.ChildViewMasterRecord().ChildCategories.unshift(newCategory);
				self.EditChildViewRecord(newCategory);
			}
			
			self.Initialize = function(dataAdapter) {
				// Initialize UI state
				self.ChildViewMasterRecord = ko.observable(null);
				self.ChildViewRecordEditing = ko.observable(null);
				self.ParentViewEnabled = true;
				self.ChildViewEnabled = false;	
				self.Glider = new GliderWidget("#glidingContainer", "#parentEditor", "#childEditor");						
				
				// Load view model data
				self.DataAdapter = dataAdapter;
				var data = self.DataAdapter.RetrieveAllCategories();
				var viewModelData = self.AllMasterCategoriesToViewModel(data);
				self.Categories = viewModelData;
			}
			
			self.Initialize(dataAdapter);
		}
		
		$(function() {
			ko.applyBindings(new CategoryViewModel(new MockDataAdapter()));
		});
	</script>
  </head>
  
  <body>
	<!-- TODO: place this in a Partial View -->
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">		  
          <img src="webicon-2.png" style="float:left;" />
		  <a class="brand" href="#" style="color:#08C;">pushmarket</a>
          
		  <div class="nav-collapse collapse">	
            <ul class="nav">
              <li class="active"><a href="#">Orders</a></li>
              <li><a href="#about">Lists</a></li>
              <li><a href="#contact">Products</a></li>
              <li><a href="#contact">Customers</a></li>
              <li><a href="#contact">Admins</a></li>
			  
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Lists<b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="#">Action</a></li>
                  <li><a href="#">Another action</a></li>
                  <li><a href="#">Something else here</a></li>
				  
                  <li class="divider"></li>
                  
				  <li class="nav-header">Nav header</li>
                  <li><a href="#">Separated link</a></li>
                  <li><a href="#">One more separated link</a></li>
                </ul>
              </li>
			</ul>
			<p class="navbar-text pull-right">Logged in as <a href="#" style="color:#08C;" class="navbar-link">aleksjones@gmail.com</a></p>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>
	
	<!-- Top Workspace -->
	<!-- TODO: clean-up this CSS -->
	<div style="position:fixed; top:0px; width:100%; height:75px; background-color:#FFF; border-bottom:1px dotted #CCC; z-index:1029">
		<!-- We'll repeat this concept everywhere -->
		<div class="workspace-heading" data-bind="template: { name: 'parent-editor-heading', data: null }"></div>
	</div>	
	
	<!-- Gliding UI Container -->
    <div id="glidingContainer" class="container" style="margin-top:75px; width:932px; height:1400px; overflow:hidden; position:relative;">		
		<div id="parentEditor" style="left:0px; width:932px; position:absolute;">
			<div data-bind="template: { name: 'parent-editor-workspace', data: $root }">
			</div>
		</div>
		
		<div data-bind="if: $root.ChildViewMasterRecord" id="childEditor" style="left:0px; width:932px; position:absolute; display:none;">
			<div data-bind="template: { name: 'child-editor-workspace', data: $root }">
			</div>
		</div>
    </div>
	
	<!-- TODO: move this to a Partial View -->
	<div class="navbar navbar-fixed-bottom">
		<div style="background-color:#FFF; height:30px; padding-top:10px;  border-top:1px dotted #CCC;">
			<div class="container">
			  <footer>
				<p>&copy; Push Global Software Solutions - LLC 2012 | <a href="#">Company</a> | <a href="#">Contact Technical Support</a></p>
			  </footer>
			</div>
		</div>
	</div>
	
	
	<!--<script src="../assets/js/bootstrap-transition.js"></script>
    <script src="../assets/js/bootstrap-alert.js"></script>
    <script src="../assets/js/bootstrap-modal.js"></script>
    <script src="../assets/js/bootstrap-dropdown.js"></script>
    <script src="../assets/js/bootstrap-scrollspy.js"></script>
    <script src="../assets/js/bootstrap-tooltip.js"></script>
    <script src="../assets/js/bootstrap-popover.js"></script>
    <script src="../assets/js/bootstrap-button.js"></script>
    <script src="../assets/js/bootstrap-collapse.js"></script>
    <script src="../assets/js/bootstrap-carousel.js"></script>
    <script src="../assets/js/bootstrap-typeahead.js"></script> -->
  </body>
</html>
