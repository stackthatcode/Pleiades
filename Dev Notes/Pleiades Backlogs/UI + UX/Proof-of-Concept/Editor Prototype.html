<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>pushmarket - edit categories</title>
	
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- What's this? -->
	<script type="text/javascript" src="jquery-1.8.2.min.js"></script>
	<script type="text/javascript" src="knockout-2.1.0.js"></script>	
	<script type="text/javascript" src="bootstrap-dropdown.js"></script>
	<script type="text/javascript" src="bootstrap-modal.js"></script>
	
	<script type="text/javascript" src="PushMarketCommon.js"></script>
	<script type="text/javascript" src="CategoryAdapter.js"></script>
    <link href="./bootstrap/css/bootstrap.css" rel="stylesheet">
	<link href="./pushmarket.css" rel="stylesheet">
	
	<!-- TODO: don't forget scroll spy, brah! -->	
	<script type="text/javascript">	
		function CategoryViewModel(dataAdapter) {	
			var self = this;
			
			// transformers
			self.AllCategoriesToViewModel = function(data) {
				var output = [];
				$.each(data, function(index, category) { 
					var knockedOutCategory = self.SingleCategoryToViewModel(category);
					output.push(knockedOutCategory); 
				});
				return output;
			}
			
			self.SingleCategoryToViewModel = function(category) {
				var output = {
					Id: ko.observable(category.Id),
					ParentId: ko.observable(category.ParentId),
					Name: ko.observable(category.Name),
					SEO: ko.observable(category.SEO),
					Categories: ko.observableArray()
				}
				
				if (category.Categories) {
					$.each(category.Categories, function (index, element) {
						output.Categories.push(self.SingleCategoryToViewModel(element));
					});
				}
				
				return output;
			}
			
			self.SingleCategoryToServerModel = function(category) {
				var output = {
					Id: category.Id(),
					ParentId: category.ParentId(),
					Name: category.Name(),
					SEO: category.SEO(),
				};
				
				return output;
			};			
			
			// UI state management methods
			self.ActiveView = function() {
				if (self.SingleParentEditorRecordset() != null) 
					return "SingleParentView";
				else
					return "AllParentsView";
			}
			
			self.GotoSingleParentView = function(parentRecord) {
				if (self.ActiveView() == "SingleParentView") return;
				
				if (parentRecord.Id() != null) {
					var data = self.DataAdapter.RetrieveById(parentRecord.Id());
					parentRecord = self.SingleCategoryToViewModel(data);
				}
				
				self.SingleParentEditorRecordset(parentRecord);				
				self.AllParentsGlider.GlideToChild();
			}
			
			self.BackToAllParentsView = function() {
				if (self.ActiveView() != "SingleParentView") return;
				
				var data = self.DataAdapter.RetrieveAll();
				var viewModel = self.AllCategoriesToViewModel(data)
				self.AllParentsEditorRecordset(viewModel);
				
				self.AllParentsGlider.GlideToParent();				
				self.ScrollToIdTracker(self.SingleParentEditorRecordset().Id());
				
				self.SingleParentEditorRecordset(null);
				self.ChosenRecordToEdit(null);
			}
			
			self.ScrollToIdTracker = function(id) {
				if (!id) return;
				var offset = $('input[value="' + id + '"]').parent().offset().top - $("#glidingContainer").offset().top;				
				$("body").scrollTop(offset);
			}
			
			self.EditRecord = function(record) {
				if (self.ActiveView() != "SingleParentView") return;
				self.ClearNonPersistedRecord();
				
				record.EditName = ko.observable(record.Name());
				record.EditSEO = ko.observable(record.SEO());				
				self.ChosenRecordToEdit(record);
			}
			
			self.CancelEdit = function(record) {
				if (self.ActiveView() != "SingleParentView") return;
				self.ClearNonPersistedRecord();
				self.ChosenRecordToEdit(null);
			}

			self.ClearNonPersistedRecord = function() {
				if (self.ChosenRecordToEdit() && self.ChosenRecordToEdit().Id() === null) {
					self.SingleParentEditorRecordset().Categories.remove(self.ChosenRecordToEdit());
				}
			}
			
			
			// CRUD operations			
			self.SaveRecord = function(record) {
				if (self.ActiveView() != "SingleParentView") return;
				
				record.Name(record.EditName());
				record.SEO(record.EditSEO());
				
				var id = self.DataAdapter.Save(self.SingleCategoryToServerModel(record));
				self.ChosenRecordToEdit().Id(id);				
				self.ChosenRecordToEdit(null);
			}
			
			self.AddParentRecord = function() {
				if (self.ActiveView() == "SingleParentView") return;
				
				var newCategory = self.SingleCategoryToViewModel(
						{ Id: null, ParentId: null, Name: "New Category", SEO: "new-category", Categories: null });
				
				self.AllParentsEditorRecordset.unshift(newCategory);
				self.EditRecord(newCategory);
				self.GotoSingleParentView(newCategory);
			}
			
			self.AddChildRecord = function() {
				if (self.ActiveView() != "SingleParentView") return;
				
				var newCategory = self.SingleCategoryToViewModel(
						{ Id: null, ParentId: self.SingleParentEditorRecordset().Id(), Name: "New Category", SEO: "new-category", Categories: null });
				
				self.SingleParentEditorRecordset().Categories.unshift(newCategory);
				self.EditRecord(newCategory);
				window.scrollTo(0, 0);
			}
			
			// initialization
			self.Initialize = function(dataAdapter) {
				// initialize UI state
				self.AllParentsGlider = new GliderWidget("#glidingContainer", "#parentEditor", "#childEditor");
				
				// load ko.observables into view model				
				self.AllParentsEditorRecordset = ko.observableArray(null);
				self.SingleParentEditorRecordset = ko.observable(null); 
				self.ChosenRecordToEdit = ko.observable(null);
				
				// save reference to data source
				self.DataAdapter = dataAdapter;
				var data = self.DataAdapter.RetrieveAll();
				var model = self.AllCategoriesToViewModel(data);
				self.AllParentsEditorRecordset(model);
			}
			
			self.Initialize(dataAdapter);
		}
		
		$(function() {
			var datasource = new CategoryDataAdapter();
			var model = new CategoryViewModel(datasource)
			ko.applyBindings(model);
		});
	</script>
	
	
	<!-- KNOCK TEMPLATE - TOP EDITOR HEADER -->
	<script type="text/html" id="Top-Editor-Header">
		<div id="heading" class="container" data-bind="ifnot: $root.SingleParentEditorRecordset()">
			<div class="row">
				<div class="span9">
					<h1>All Categories</h1>
				</div>
				<div class="span3" style="margin-top:15px; text-align:right;">
					<a class="btn btn-primary btn-block" data-bind="click: $root.AddParentRecord">Add New Category <i class="icon-arrow-right icon-white"></i></a>
				</div>
			</div>
		</div>
		
		<div id="heading" class="container" data-bind="if: $root.SingleParentEditorRecordset()">
			<div class="row" style="position:relative;">
				<!-- TODO: move to CSS file -->
				<div style="left:-75px; margin-top:15px; position:absolute; text-align:right;">
					<a class="btn btn-inverse" data-bind="click: $root.BackToAllParentsView"><i class="icon-arrow-left icon-white"></i> Back</a>
				</div>
				<div class="span9">
					<h1><span data-bind="text: $root.SingleParentEditorRecordset().Name"></span></h1>
				</div>
				<div class="span3" style="margin-top:15px; text-align:right;" data-bind="visible: $root.SingleParentEditorRecordset().Id">
					<a class="btn btn-primary btn-block" data-bind="click: $root.AddChildRecord"><i class="icon-plus icon-white"></i> Add Sub-Category</a>
				</div>
			</div>
		</div>
	</script>
	
	<!-- KNOCK TEMPLATE - ALL PARENTS EDITOR WORKSPACE -->
	<script type="text/html" id="All-Parents-Editor-Workspace">
		<table id="parent-editor-table" class="table table-hover">
			<tbody data-bind="foreach: $root.AllParentsEditorRecordset()">
			<tr>
				<td>
					<span class="span9">
						<input type="hidden" data-bind="value: $data.Id" />
						<h4 data-bind="text: Name"></h4>
						<div data-bind="foreach: $data.Categories">
							<h4 style="padding-left:40px;">&raquo; <span data-bind="text: Name"></span></h4>
						</div>
					</span>
					<span class="span3" style="text-align:right;">
						<a class="btn" href="#"><i class="icon-chevron-up"></i></a>
						<a class="btn btn-inverse" data-bind="click: $root.GotoSingleParentView">Edit Category<i class="icon-arrow-right icon-white"></i></a>
					</span>
				</td>
			</tr>
			</tbody>
		</table>
	</script>
	
	<!-- KNOCK TEMPLATE - SINGLE PARENT EDITOR WORKSPACE -->
	<script type="text/html" id="Single-Parent-Editor-Workspace">
		<table id="single-parent-editor-toprow" class="table table-hover" style="margin-bottom:0px;">
			<tbody data-bind="template: { name: 'Editor-Row-Template', data: $data }">
			</tbody>
		</table>
		
		<table id="single-parent-editor-otherrows" class="table table-hover">
			<tbody data-bind="template: { name: 'Editor-Row-Template', foreach: $data.Categories }">
			</tbody>
		</table>
	</script>
	
	<!-- KNOCK TEMPLATE - EDITOR ROW -->
	<script type="text/html" id="Editor-Row-Template">
		<tr data-bind="if: $root.ChosenRecordToEdit() != $data, click: $root.EditRecord">
		<td>
			<span class="span9">	
				<input type="hidden" data-bind="value: $data.Id" />					
				<div data-bind="if: $data.ParentId() == null">
					<h4 data-bind="text: $data.Name()"></h4>
					<span data-bind="text: $data.SEO()"></span>
				</div>					
				<div data-bind="if: $data.ParentId() != null" style="padding-left:20px;">
					<h4 data-bind="text: '&raquo; ' + $data.Name()"></h4>
					<span data-bind="text: $data.SEO()"></span>
				</div>
			</span>				
			<span class="span3" style="text-align:right;">
				<p>Touch Row to Edit</p>
			</span>
		</td>
		</tr>
		
		<tr data-bind="if: $root.ChosenRecordToEdit() == $data, singleParentFixHeight: $root.ChosenRecordToEdit() == $data">
		<td style="background-color:#EEE;">
			<form>
			<div>
				<span class="span8" style="float:left;padding-top:5px;">
					<input id="entry" class="input-large" style="float:left; width:250px; margin-right:20px;" type="text" placeholder="Enter Category Name" data-bind="value: $data.EditName" />
					<input id="entry" class="input-large" style="float:left; width:250px;" type="text" value="sport-casual-seo-tag" placeholder="Enter SEO Tag" data-bind="value: $data.EditSEO" />
				</span>
				<span class="span4" style="padding-top:5px; text-align:right;">
					<a class="btn btn-primary" href="#" data-bind="click: $root.SaveRecord"><i class="icon-ok icon-white"></i> Save</a>
					<a class="btn btn-primary" href="#"><i class="icon-trash icon-white"></i> Delete</a>
					<a class="btn btn-inverse" href="#" data-bind="click: $root.CancelEdit"><i class="icon-remove icon-white"></i> Cancel</a>
				</span>
			</div>					
			<div style="clear:both; height:20px;width:1px;" />
			<div>
				<span class="span9" style="float:left;">					
					<a class="btn btn-inverse" href="#" style="float:left; margin-right:5px;"><i class="icon-search icon-white"></i> Products</a>
					
					<div class="dropdown" style="float:left;">
						<a class="btn btn-primary dropdown-toggle" data-toggle="dropdown" href="#">
							Change Parent Category...<span class="caret"></span>
						</a>
						<ul class="dropdown-menu" role="menu" aria-labelledby="drop1">
							<div data-bind="foreach: $root.AllParentsEditorRecordset()">	
							<li data-bind="if: $data.Id() !== $root.SingleParentEditorRecordset().Id()">
								<a tabindex="-1" data-bind="text: $data.Name()" href="#"></a>
							</li>
							</div>
							
							<li class="divider"></li>
							<li><a tabindex="-1" href="#">Make this a Parent Category</a></li>
						</ul>
					</div>
				</span>						
				<span class="span3">
				</span>
			</div>
			</form>
		</td>
		</tr>
	</script>	
  </head>
  
  <body>
	<!-- TODO: place this in an ASP.NET MVC Partial View -->
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">		  
          <img src="webicon-2.png" style="float:left;" />
		  <a class="brand" href="#" style="color:#08C;">pushmarket</a>
          
		  <div class="nav-collapse collapse">	
            <ul class="nav">
              <li class="active"><a href="#">Orders</a></li>
              <li><a href="#about">Lists</a></li>
              <li><a href="#contact">Products</a></li>
              <li><a href="#contact">Customers</a></li>
              <li><a href="#contact">Admins</a></li>
			  
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Lists<b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="#">Action</a></li>
                  <li><a href="#">Another action</a></li>
                  <li><a href="#">Something else here</a></li>
				  
                  <li class="divider"></li>
                  
				  <li class="nav-header">Nav header</li>
                  <li><a href="#">Separated link</a></li>
                  <li><a href="#">One more separated link</a></li>
                </ul>
              </li>
			</ul>
			<p class="navbar-text pull-right">Logged in as <a href="#" style="color:#08C;" class="navbar-link">aleksjones@gmail.com</a></p>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>
	
	<div class="workspace-heading-parent">
		<div class="workspace-heading" data-bind="template: { name: 'Top-Editor-Header', data: $root }"></div>
	</div>
	
    <div id="glidingContainer" class="container" style="top:140px; width:932px; position:relative;">
		<div id="parentEditor" style="left:0px; width:932px; position:absolute;">
			<div style="margin-bottom:150px;" data-bind="template: { name: 'All-Parents-Editor-Workspace', data: $root.AllParentsEditorRecordset() }">
			</div>
		</div>
		
		<div id="childEditor" style="left:0px; width:932px; position:absolute; display:none;" data-bind="if: $root.SingleParentEditorRecordset()">
			<div style="margin-bottom:150px;" data-bind="template: { name: 'Single-Parent-Editor-Workspace', data: $root.SingleParentEditorRecordset() }">
			</div>
		</div>
    </div>
	
	<!-- TODO: move this to a Partial View -->
	<div class="navbar navbar-fixed-bottom">
		<div style="background-color:#FFF; height:30px; padding-top:10px;  border-top:1px dotted #CCC;">
			<div class="container">
			  <footer>
				<p>&copy; Push Global Software Solutions - LLC 2012 | <a href="#">Company</a> | <a href="#">Contact Technical Support</a></p>
			  </footer>
			</div>
		</div>
	</div>
  </body>
</html>
